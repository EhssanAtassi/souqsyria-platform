# ============================================================================
# Nginx Configuration for SouqSyria Angular SPA
# ============================================================================
# This configuration serves the Angular single-page application (SPA) and
# proxies API requests to the backend NestJS server. Includes security headers,
# compression, caching strategies, and proper SPA routing configuration.
# ============================================================================

user nginx;

# Auto-detect number of CPU cores for optimal performance
# Each worker processes handles connections and requests
worker_processes auto;

# Maximum number of open file descriptors per worker process
# Increased for high-concurrency environments
worker_rlimit_nofile 65535;

# Error log configuration
# Logs errors to stderr which is captured by container logging
error_log /dev/stderr warn;

# Process ID file location
pid /var/run/nginx.pid;

# Main event block configuration
events {
  # Maximum number of simultaneous connections per worker
  worker_connections 4096;
  
  # Use efficient event multiplexing method
  use epoll;
  
  # Enable multi-accept optimization
  multi_accept on;
}

# HTTP configuration
http {
  # Include MIME types mapping
  include /etc/nginx/mime.types;
  
  # Default MIME type for unmapped file extensions
  default_type application/octet-stream;

  # ========================================================================
  # Logging Configuration
  # ========================================================================
  # Log format includes request timing for performance monitoring
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for" '
                  'rt=$request_time uct="$upstream_connect_time" '
                  'uht="$upstream_header_time" urt="$upstream_response_time"';

  # Log all requests to stdout for container logging
  # Allows Docker logs to capture all traffic
  access_log /dev/stdout main;

  # ========================================================================
  # Performance Optimization
  # ========================================================================
  
  # Enable sending files directly from disk to socket (reduces CPU usage)
  sendfile on;
  
  # Use TCP_CORK to optimize network packet transmission
  tcp_nopush on;
  tcp_nodelay on;
  
  # Timeout for keep-alive connections (reduces resource usage)
  keepalive_timeout 65;
  
  # Client body timeout - prevent slow uploads from holding connections
  client_body_timeout 12;
  
  # Client header timeout - prevent slowloris attacks
  client_header_timeout 12;
  
  # Send timeout - prevent slow clients from blocking server
  send_timeout 10;

  # Increase buffer sizes for large requests
  client_body_buffer_size 128k;
  client_max_body_size 10m;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 8k;

  # ========================================================================
  # Gzip Compression Configuration
  # ========================================================================
  # Reduces bandwidth usage and improves page load times
  # Particularly effective for text-based content (HTML, CSS, JS, JSON)
  
  # Enable gzip compression
  gzip on;
  
  # Minimum file size to compress (smaller files don't benefit)
  gzip_min_length 1024;
  
  # Compression level: 1-9 (higher = more compression but more CPU)
  # Level 6 provides good balance between compression and performance
  gzip_comp_level 6;
  
  # HTTP version requirement for gzip
  gzip_http_version 1.1;
  
  # MIME types to compress (text, scripts, JSON, SVG)
  gzip_types text/plain text/css text/xml text/javascript 
             application/x-javascript application/javascript 
             application/json application/xml+rss 
             application/svg+xml
             font/truetype font/opentype application/vnd.ms-fontobject 
             image/svg+xml;
  
  # Disable gzip for Internet Explorer 6 (compatibility)
  gzip_disable "msie6";
  
  # Add gzip encoding header for proxies
  gzip_vary on;
  
  # Proxies should respect gzip settings
  gzip_proxied any;

  # ========================================================================
  # Upstream Backend Configuration
  # ========================================================================
  # Defines the backend NestJS server for API requests
  # Using DNS resolution allows container-to-container communication
  
  upstream backend {
    # Health check for backend server
    # Mark backend as down if it doesn't respond for 3 consecutive checks
    # Requests will be queued and retried when backend is back online
    server backend:3000 max_fails=3 fail_timeout=30s;
    
    # Enable keep-alive connections to backend
    # Reduces connection overhead for repeated requests
    keepalive 32;
  }

  # ========================================================================
  # Server Block Configuration
  # ========================================================================
  # Main server block for handling HTTP requests
  
  server {
    # Listen on port 80 (HTTP)
    listen 80 default_server;
    
    # Server name - catch all hostnames
    server_name _;
    
    # Root directory for static files
    root /usr/share/nginx/html;
    
    # ====================================================================
    # Security Headers
    # ====================================================================
    # These headers improve security posture and protect against
    # common web vulnerabilities
    
    # Prevent clickjacking attacks
    # Restricts this site from being embedded in frames
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Enable MIME type sniffing protection
    # Prevents browsers from interpreting files as different types
    add_header X-Content-Type-Options "nosniff" always;
    
    # Enable XSS protection in older browsers
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Enforce HTTPS for next 1 year (31536000 seconds)
    # HSTS ensures all future connections use HTTPS
    # includeSubDomains applies to all subdomains
    # Uncomment after setting up HTTPS certificates
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Content Security Policy (CSP)
    # Restricts sources of content to prevent XSS attacks
    # - default-src: Source for all content (most restrictive)
    # - script-src: Allowed sources for scripts
    # - style-src: Allowed sources for stylesheets
    # - img-src: Allowed sources for images
    # - font-src: Allowed sources for fonts
    # - connect-src: Allowed sources for XMLHttpRequest, WebSocket
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' http://localhost:3000 http://backend:3000;" always;
    
    # Referrer Policy
    # Controls how much referrer information is shared
    # strict-no-referrer: Never send referrer
    add_header Referrer-Policy "strict-no-referrer-when-downgrade" always;
    
    # Feature Policy / Permissions Policy
    # Controls browser features and APIs
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # ====================================================================
    # Caching Configuration
    # ====================================================================
    # Strategic caching reduces bandwidth and improves performance
    
    # Cache static assets with content hash (long-term cache)
    # Angular includes content hash in filenames (e.g., main.abc123.js)
    location ~* ^/.*\.[0-9a-f]{20}\.(js|css|woff|woff2|ttf|svg)$ {
      # Cache for 1 year (31536000 seconds)
      # Content hash ensures new version when file changes
      expires 1y;
      
      # Add cache validation headers
      add_header Cache-Control "public, immutable";
      
      # Security headers for assets
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
    }
    
    # Cache images for 30 days
    location ~* \.(jpg|jpeg|png|gif|ico|webp)$ {
      expires 30d;
      add_header Cache-Control "public";
    }
    
    # Cache fonts for 30 days
    location ~* \.(ttf|woff|woff2|eot|svg)$ {
      expires 30d;
      add_header Cache-Control "public";
    }
    
    # Don't cache HTML files (SPA index.html must be revalidated)
    # Prevents browsers from using stale index.html
    location ~* \.html?$ {
      expires -1;
      add_header Cache-Control "public, must-revalidate";
    }

    # ====================================================================
    # API Proxy Configuration
    # ====================================================================
    # Routes /api/* requests to backend NestJS server
    
    location /api/ {
      # Proxy pass to backend upstream
      proxy_pass http://backend;
      
      # ================================================================
      # Proxy Headers - Forward client information to backend
      # ================================================================
      
      # Forward original Host header (important for CORS)
      proxy_set_header Host $host;
      
      # Forward original client IP address to backend
      # Used by backend for logging and rate limiting
      proxy_set_header X-Real-IP $remote_addr;
      
      # Forward proxy chain for load balancers
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      
      # Forward original protocol (http/https)
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # Forward original path
      proxy_set_header X-Forwarded-Path $request_uri;
      
      # Forward Host header for virtual hosting
      proxy_set_header X-Forwarded-Host $server_name;
      
      # Preserve request URL exactly
      proxy_set_header Request-URI $request_uri;
      
      # ================================================================
      # Proxy Buffering and Timeouts
      # ================================================================
      
      # Enable buffering for large responses
      proxy_buffering on;
      
      # Buffer sizes for response
      proxy_buffer_size 128k;
      proxy_buffers 4 256k;
      
      # Connect timeout - max time to establish connection
      proxy_connect_timeout 60s;
      
      # Send timeout - max time waiting to send request
      proxy_send_timeout 60s;
      
      # Read timeout - max time waiting for response
      proxy_read_timeout 60s;
      
      # ================================================================
      # Proxy Connection Management
      # ================================================================
      
      # Use HTTP/1.1 for backend connection (important for keep-alive)
      proxy_http_version 1.1;
      
      # Don't close connection after request
      proxy_set_header Connection "";
      
      # Enable keep-alive to backend
      proxy_set_header Connection "upgrade";
      
      # ================================================================
      # Response Headers from Backend
      # ================================================================
      
      # Pass response headers from backend as-is
      proxy_pass_header Server;
      proxy_pass_header Set-Cookie;
      
      # Don't ignore Location header from backend
      proxy_redirect off;
      
      # ================================================================
      # Upstream Error Handling
      # ================================================================
      
      # Retry with different server on error
      proxy_next_upstream error timeout http_502 http_503 http_504;
      
      # Max retries
      proxy_next_upstream_tries 1;
    }

    # ====================================================================
    # WebSocket Support
    # ====================================================================
    # Enable WebSocket proxying for real-time features
    
    location /socket.io/ {
      # Proxy to backend for WebSocket upgrade
      proxy_pass http://backend;
      
      # WebSocket upgrade headers
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      
      # Forward client information
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # WebSocket timeouts (longer than HTTP)
      proxy_connect_timeout 7d;
      proxy_send_timeout 7d;
      proxy_read_timeout 7d;
    }

    # ====================================================================
    # SPA Routing Configuration
    # ====================================================================
    # Angular SPA requires all non-static requests to be routed to
    # index.html for client-side routing to work properly
    
    # Try to serve file directly, fallback to index.html
    location / {
      # Try these in order:
      # 1. Serve the requested file if it exists
      # 2. Try directory index if path is a directory
      # 3. Fall back to index.html for SPA routing
      try_files $uri $uri/ /index.html;
      
      # Security headers for index.html
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header Cache-Control "public, must-revalidate";
      
      # Never cache index.html
      expires -1;
    }

    # ====================================================================
    # Deny Access to Sensitive Files
    # ====================================================================
    
    # Block access to hidden files (starting with .)
    location ~ /\. {
      deny all;
      access_log off;
      log_not_found off;
    }
    
    # Block access to environment files
    location ~ ~$ {
      deny all;
      access_log off;
      log_not_found off;
    }
    
    # Block common sensitive paths
    location ~ ^/(node_modules|src|.git|.angular) {
      deny all;
      access_log off;
      log_not_found off;
    }

    # ====================================================================
    # Health Check Endpoint
    # ====================================================================
    # Used by load balancers and container orchestration
    
    location /healthz {
      access_log off;
      return 200 "healthy\n";
      add_header Content-Type text/plain;
    }

    # ====================================================================
    # Status and Metrics Endpoints (Disabled in Production)
    # ====================================================================
    # Uncomment for debugging, disable in production
    
    # location /nginx_status {
    #   stub_status on;
    #   access_log off;
    #   allow 127.0.0.1;
    #   deny all;
    # }
  }
}
