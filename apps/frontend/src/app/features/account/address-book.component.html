<!-- Address Book Header -->
<div class="address-book-header">
  <div class="container mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div class="header-content">
        <h1 class="text-2xl font-bold text-gray-900">
          {{ 'account.addresses.title' | translate }}
        </h1>
        <p class="text-gray-600 mt-1">
          {{ 'account.addresses.subtitle' | translate }}
        </p>
      </div>

      <button mat-raised-button
              color="primary"
              (click)="openNewForm()"
              class="add-address-btn">
        <mat-icon>add</mat-icon>
        {{ 'account.addresses.addNew' | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
@if (isLoading()) {
  <div class="loading-container p-8 text-center">
    <mat-progress-bar mode="indeterminate" class="mb-4"></mat-progress-bar>
    <p class="text-gray-600">{{ 'account.addresses.loading' | translate }}</p>
  </div>
}

<!-- Address Form Modal -->
@if (showForm()) {
  <div class="address-form-overlay fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="address-form-modal bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
      <div class="modal-header bg-gradient-to-r from-amber-400 to-yellow-500 p-4 text-white">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">{{ formTitle() }}</h3>
          <button mat-icon-button (click)="closeForm()" class="text-white">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <form [formGroup]="addressForm" (ngSubmit)="saveAddress()" class="modal-body p-6">
        <!-- Label -->
        <div class="mb-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>{{ 'account.addresses.label' | translate }}</mat-label>
            <input matInput formControlName="label" placeholder="Home, Work...">
          </mat-form-field>
          <div class="label-presets flex gap-2 mb-4">
            @for (preset of labelPresets; track preset.value) {
              <button type="button"
                      mat-stroked-button
                      (click)="addressForm.patchValue({ label: preset.value })"
                      class="preset-btn">
                <mat-icon>{{ preset.icon }}</mat-icon>
                {{ preset.value }}
              </button>
            }
          </div>
        </div>

        <!-- Address Lines -->
        <mat-form-field appearance="outline" class="w-full mb-4">
          <mat-label>{{ 'account.addresses.addressLine1' | translate }}</mat-label>
          <input matInput formControlName="addressLine1">
          @if (addressForm.get('addressLine1')?.hasError('required') && addressForm.get('addressLine1')?.touched) {
            <mat-error>{{ 'account.addresses.addressRequired' | translate }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full mb-4">
          <mat-label>{{ 'account.addresses.addressLine2' | translate }}</mat-label>
          <input matInput formControlName="addressLine2">
          <mat-hint>{{ 'account.addresses.optional' | translate }}</mat-hint>
        </mat-form-field>

        <!-- Phone -->
        <mat-form-field appearance="outline" class="w-full mb-4">
          <mat-label>{{ 'account.addresses.phone' | translate }}</mat-label>
          <input matInput formControlName="phone" placeholder="+963XXXXXXXXX">
          @if (addressForm.get('phone')?.hasError('required') && addressForm.get('phone')?.touched) {
            <mat-error>{{ 'account.addresses.phoneRequired' | translate }}</mat-error>
          }
          @if (addressForm.get('phone')?.hasError('pattern') && addressForm.get('phone')?.touched) {
            <mat-error>{{ 'account.addresses.phoneInvalid' | translate }}</mat-error>
          }
        </mat-form-field>

        <!-- Notes -->
        <mat-form-field appearance="outline" class="w-full mb-4">
          <mat-label>{{ 'account.addresses.notes' | translate }}</mat-label>
          <textarea matInput formControlName="notes" rows="2"></textarea>
          <mat-hint>{{ 'account.addresses.notesHint' | translate }}</mat-hint>
        </mat-form-field>

        <!-- Default checkbox -->
        <div class="mb-6">
          <mat-checkbox formControlName="isDefault">
            {{ 'account.addresses.setAsDefault' | translate }}
          </mat-checkbox>
        </div>

        <!-- Form Actions -->
        <div class="form-actions flex justify-end gap-3">
          <button type="button" mat-button (click)="closeForm()">
            {{ 'cancel' | translate }}
          </button>
          <button type="submit"
                  mat-raised-button
                  color="primary"
                  [disabled]="addressForm.invalid"
                  class="save-btn">
            <mat-icon>save</mat-icon>
            {{ 'save' | translate }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Main Content -->
@if (!isLoading()) {
  <div class="address-book-content container mx-auto px-4 py-6">

    <!-- Default Address Highlight -->
    @if (defaultAddress(); as defAddr) {
      <div class="default-addresses mb-8">
        <h2 class="text-lg font-semibold mb-4 text-gray-900">
          {{ 'account.addresses.defaultAddress' | translate }}
        </h2>
        <mat-card class="default-address-card shipping-card">
          <mat-card-header>
            <mat-icon mat-card-avatar class="shipping-icon">local_shipping</mat-icon>
            <mat-card-title>{{ defAddr.label || 'Default' }}</mat-card-title>
            <mat-card-subtitle>{{ formatAddress(defAddr) }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p class="text-gray-500 mt-2">{{ defAddr.phone }}</p>
            @if (defAddr.notes) {
              <p class="text-sm text-blue-600 mt-1">
                <mat-icon class="text-sm align-middle">info</mat-icon>
                {{ defAddr.notes }}
              </p>
            }
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary" (click)="openEditForm(defAddr)">
              <mat-icon>edit</mat-icon>
              {{ 'edit' | translate }}
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    }

    <!-- All Addresses -->
    <h2 class="text-lg font-semibold mb-4 text-gray-900">
      {{ 'account.addresses.allAddresses' | translate }}
    </h2>

    @if (addresses().length === 0) {
      <!-- Empty State -->
      <div class="empty-state text-center py-12">
        <mat-icon class="text-6xl text-gray-400 mb-4">location_off</mat-icon>
        <h3 class="text-lg font-medium text-gray-600 mb-2">
          {{ 'account.addresses.empty' | translate }}
        </h3>
        <p class="text-gray-500 mb-6">
          {{ 'account.addresses.emptyDesc' | translate }}
        </p>
        <button mat-raised-button color="primary" (click)="openNewForm()">
          <mat-icon>add</mat-icon>
          {{ 'account.addresses.addNew' | translate }}
        </button>
      </div>
    } @else {
      <!-- Address Cards Grid -->
      <div class="addresses-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        @for (address of addresses(); track address.id) {
          <mat-card class="address-card" [class.default-shipping]="address.isDefault">
            <mat-card-header>
              <mat-icon mat-card-avatar>location_on</mat-icon>
              <mat-card-title>
                {{ address.label || ('account.addresses.noLabel' | translate) }}
                @if (address.isDefault) {
                  <mat-chip class="default-chip">
                    {{ 'account.addresses.default' | translate }}
                  </mat-chip>
                }
              </mat-card-title>
              <mat-card-subtitle>{{ address.addressType }}</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <p class="address-text text-gray-600 mb-2">{{ formatAddress(address) }}</p>
              <p class="text-gray-500 text-sm">{{ address.phone }}</p>
              @if (address.notes) {
                <p class="text-sm text-blue-600 mt-1">{{ address.notes }}</p>
              }
            </mat-card-content>

            <mat-card-actions>
              <button mat-button color="primary" (click)="openEditForm(address)">
                <mat-icon>edit</mat-icon>
                {{ 'edit' | translate }}
              </button>

              <button mat-button [matMenuTriggerFor]="addressMenu">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #addressMenu="matMenu">
                @if (!address.isDefault) {
                  <button mat-menu-item (click)="setDefault(address)">
                    <mat-icon>star</mat-icon>
                    <span>{{ 'account.addresses.setAsDefault' | translate }}</span>
                  </button>
                }
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="deleteAddress(address)">
                  <mat-icon color="warn">delete</mat-icon>
                  <span>{{ 'account.addresses.delete' | translate }}</span>
                </button>
              </mat-menu>
            </mat-card-actions>
          </mat-card>
        }
      </div>
    }
  </div>
}
