<div class="product-detail-page" [class.rtl]="language() === 'ar'">
  <!-- Loading State -->
  @if (loading()) {
    <div class="product-detail-page__loading">
      <mat-icon class="spinner">hourglass_empty</mat-icon>
      <p>{{ language() === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="product-detail-page__error">
      <mat-icon class="product-detail-page__error-icon">error_outline</mat-icon>
      <h2 class="product-detail-page__error-title">{{ error() }}</h2>
      <button mat-raised-button color="primary" (click)="retryLoad()">
        <mat-icon>refresh</mat-icon>
        <span>{{ retryLabel }}</span>
      </button>
    </div>
  }

  <!-- Product Content -->
  @else if (product()) {
    <!-- JSON-LD Structured Data -->
    <app-json-ld [data]="productJsonLd()" />

    <!-- Breadcrumb -->
    <app-breadcrumb [items]="breadcrumbItems()" [language]="language()"></app-breadcrumb>

    <!-- Main Product Section -->
    <div class="product-detail">
      <!-- Image Gallery Component -->
      <div class="product-detail__gallery">
        <app-image-gallery
          [images]="product()!.images"
          [productName]="productName()"
          [language]="language()"
          [selectedIndex]="variantImageIndex()"
          (imageChange)="onGalleryImageChange($event)"
        />
      </div>

      <!-- Product Info -->
      <div class="product-detail__info">
        <h1 class="info__title">{{ productName() }}</h1>

        <!-- Star Rating Summary (if available) -->
        @if (reviewSummary() && reviewSummary()!.totalReviews > 0) {
          <div class="info__rating">
            <div class="rating__stars" role="img" [attr.aria-label]="ratingAriaLabel()">
              @for (star of [1, 2, 3, 4, 5]; track star) {
                <mat-icon class="star-icon" aria-hidden="true">
                  {{ star <= Math.floor(reviewSummary()!.averageRating) ? 'star' :
                     (star === Math.ceil(reviewSummary()!.averageRating) && reviewSummary()!.averageRating % 1 >= 0.5) ? 'star_half' : 'star_border' }}
                </mat-icon>
              }
            </div>
            <span class="rating__text">
              {{ reviewSummary()!.averageRating | number:'1.1-1' }}
              ({{ reviewSummary()!.totalReviews }} {{ language() === 'ar' ? 'مراجعة' : 'reviews' }})
            </span>
          </div>
        }

        <!-- Price (variant-aware) -->
        <div class="info__pricing">
          @if (selectedVariant()) {
            <span class="info__price" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedEffectivePrice() }}</span>
          } @else if (hasDiscount()) {
            <span class="info__price info__price--discounted" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedDiscountPrice() }}</span>
            <span class="info__price info__price--original" [attr.aria-label]="originalPriceAriaLabel()">{{ formattedBasePrice() }}</span>
          } @else {
            <span class="info__price" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedBasePrice() }}</span>
          }
        </div>

        <!-- Stock Badge (variant-aware) -->
        <div class="info__stock">
          <span class="stock-badge" [class]="effectiveStockClass()" role="status" [attr.aria-label]="effectiveStockLabel()">
            {{ effectiveStockLabel() }}
          </span>
        </div>

        <!-- SKU -->
        @if (product()!.sku) {
          <p class="info__sku">SKU: {{ product()!.sku }}</p>
        }

        <!-- Variant Selector -->
        @if (product()!.variants.length > 0) {
          <div class="info__variants">
            <app-variant-selector
              [variants]="product()!.variants"
              [language]="language()"
              [attributes]="product()!.attributes"
              (variantSelect)="onVariantSelect($event)"
            />
          </div>
        }

        <mat-divider class="info__divider"></mat-divider>

        <!-- Quantity Selector -->
        <div class="info__quantity">
          <label class="info__quantity-label">{{ language() === 'ar' ? 'الكمية' : 'Quantity' }}</label>
          <div class="quantity-controls">
            <button
              mat-icon-button
              (click)="onQuantityChange(-1)"
              [attr.aria-label]="language() === 'ar' ? 'إنقاص الكمية' : 'Decrease quantity'"
            >
              <mat-icon>remove</mat-icon>
            </button>
            <span class="quantity-value">{{ quantity() }}</span>
            <button
              mat-icon-button
              (click)="onQuantityChange(1)"
              [attr.aria-label]="language() === 'ar' ? 'زيادة الكمية' : 'Increase quantity'"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="info__actions">
          <button
            mat-raised-button
            color="primary"
            class="info__add-to-cart"
            (click)="onAddToCart()"
            [disabled]="effectiveStockStatus() === 'out_of_stock'"
          >
            <mat-icon>shopping_cart</mat-icon>
            <span>{{ addToCartLabel }}</span>
          </button>

          <button
            mat-icon-button
            class="info__wishlist"
            [class.info__wishlist--active]="isInWishlist()"
            (click)="onAddToWishlist()"
            [attr.aria-label]="addToWishlistLabel"
          >
            <mat-icon>{{ isInWishlist() ? 'favorite' : 'favorite_border' }}</mat-icon>
          </button>

          <button
            mat-icon-button
            class="info__compare"
            [class.info__compare--active]="isInComparison()"
            (click)="onAddToComparison()"
            [attr.aria-label]="language() === 'ar' ? 'مقارنة المنتج' : 'Compare Product'"
          >
            <mat-icon>{{ isInComparison() ? 'compare' : 'compare_arrows' }}</mat-icon>
          </button>
        </div>

        <!-- Share Buttons -->
        <div class="info__share">
          <span class="share-label">{{ language() === 'ar' ? 'مشاركة' : 'Share' }}:</span>
          <div class="share-buttons">
            @if (isNativeShareSupported) {
              <button
                mat-icon-button
                class="share-button"
                (click)="onShareNative()"
                [attr.aria-label]="language() === 'ar' ? 'مشاركة' : 'Share'"
              >
                <mat-icon>share</mat-icon>
              </button>
            }

            <button
              mat-icon-button
              class="share-button share-button--whatsapp"
              (click)="onShareWhatsApp()"
              [attr.aria-label]="language() === 'ar' ? 'مشاركة عبر واتساب' : 'Share on WhatsApp'"
            >
              <mat-icon svgIcon="whatsapp">chat</mat-icon>
            </button>

            <button
              mat-icon-button
              class="share-button share-button--facebook"
              (click)="onShareFacebook()"
              [attr.aria-label]="language() === 'ar' ? 'مشاركة على فيسبوك' : 'Share on Facebook'"
            >
              <mat-icon svgIcon="facebook">facebook</mat-icon>
            </button>

            <button
              mat-icon-button
              class="share-button share-button--twitter"
              (click)="onShareTwitter()"
              [attr.aria-label]="language() === 'ar' ? 'مشاركة على تويتر' : 'Share on Twitter'"
            >
              <mat-icon>tag</mat-icon>
            </button>

            <button
              mat-icon-button
              class="share-button"
              (click)="onCopyLink()"
              [attr.aria-label]="language() === 'ar' ? 'نسخ الرابط' : 'Copy Link'"
            >
              <mat-icon>link</mat-icon>
            </button>
          </div>
        </div>

        <!-- Notify Me for out-of-stock products -->
        @if (effectiveStockStatus() === 'out_of_stock') {
          <button mat-stroked-button
                  color="primary"
                  class="product-detail__notify-btn"
                  (click)="onNotifyMe()">
            <mat-icon>notifications_active</mat-icon>
            {{ 'productDetail.notifyMeWhenAvailable' | translate }}
          </button>
        }

        <!-- Short Description -->
        @if (descriptionForLang()?.shortDescription) {
          <p class="info__short-description">{{ descriptionForLang()!.shortDescription }}</p>
        }
      </div>
    </div>

    <!-- Tabs: Description | Specifications | Reviews -->
    <mat-tab-group class="product-detail__tabs">
      <mat-tab [label]="descriptionTabLabel">
        <div class="tab-content">
          @if (sanitizedDescription()) {
            <div [innerHTML]="sanitizedDescription()" class="description-content"></div>
          } @else {
            <p class="tab-content__empty">{{ language() === 'ar' ? 'لا يوجد وصف متاح' : 'No description available' }}</p>
          }
        </div>
      </mat-tab>

      <mat-tab [label]="specificationsTabLabel">
        <div class="tab-content">
          <app-specifications-table
            [attributes]="product()!.attributes"
            [language]="language()"
          />
        </div>
      </mat-tab>

      <mat-tab [label]="reviewsTabLabel">
        <div class="tab-content tab-content--reviews">
          <!-- Review Summary -->
          @if (reviewSummary() && reviewSummary()!.totalReviews > 0) {
            <app-review-summary
              [summary]="reviewSummary()!"
              [language]="language()"
            />
          }

          <!-- Review Form (collapsible) -->
          @if (showReviewForm()) {
            <app-review-form
              [slug]="product()!.slug"
              [language]="language()"
              [isAuthenticated]="isAuthenticated()"
              (reviewSubmitted)="onReviewSubmitted()"
            />
          }

          <!-- Review List -->
          <app-review-list
            [slug]="product()!.slug"
            [language]="language()"
            (writeReview)="onWriteReview()"
          />
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Related Products -->
    @if (relatedProductItems().length > 0) {
      <section class="product-detail__related">
        <h2 class="related__heading">{{ relatedProductsHeading }}</h2>
        <div class="related__grid">
          @for (relatedProduct of relatedProductItems(); track relatedProduct.id) {
            <app-product-card
              [product]="relatedProduct"
              [language]="language()"
            />
          }
        </div>
      </section>
    }

    <!-- Recently Viewed Products -->
    <section class="product-detail__recently-viewed">
      <app-recently-viewed
        [maxItems]="8"
        [showClearButton]="true"
        [title]="language() === 'ar' ? 'شاهدته مؤخراً' : 'Recently Viewed'"
        [titleAr]="'شاهدته مؤخراً'"
      />
    </section>

    <!-- Mobile Sticky Add to Cart -->
    <div class="product-detail__sticky-cart">
      <div class="sticky-cart__price">
        @if (selectedVariant()) {
          <span class="sticky-cart__price-text" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedEffectivePrice() }}</span>
        } @else if (hasDiscount()) {
          <span class="sticky-cart__discount-price" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedDiscountPrice() }}</span>
        } @else {
          <span class="sticky-cart__price-text" [attr.aria-label]="currentPriceAriaLabel()">{{ formattedBasePrice() }}</span>
        }
      </div>
      <button
        mat-raised-button
        color="primary"
        class="sticky-cart__button"
        (click)="onAddToCart()"
        [disabled]="effectiveStockStatus() === 'out_of_stock'"
      >
        <mat-icon>shopping_cart</mat-icon>
        {{ addToCartLabel }}
      </button>
    </div>
  }
</div>
