<h2 mat-dialog-title>
  <mat-icon>link</mat-icon>
  Bulk Map Routes to Permission
</h2>

<mat-dialog-content class="dialog-content">
  <!-- Multi-step wizard -->
  <mat-stepper [linear]="true" #stepper>

    <!-- Step 1: Review Selection -->
    <mat-step label="Review Selection">
      <div class="step-content">
        <div class="step-header">
          <mat-icon>checklist</mat-icon>
          <h3>Selected Routes ({{ routeCount() }})</h3>
        </div>

        <p class="step-description">
          Review the routes that will be mapped to a permission
        </p>

        <mat-list class="routes-list">
          @for (route of data.routes; track trackByRouteId($index, route)) {
            <mat-list-item>
              <div matListItemIcon>
                <app-method-badge [method]="route.method" />
              </div>
              <div matListItemTitle>
                <code class="route-path">{{ route.path }}</code>
              </div>
              <div matListItemLine class="route-handler">
                <mat-icon class="handler-icon">code</mat-icon>
                <span>{{ route.controller }}.{{ route.handler }}()</span>
              </div>
            </mat-list-item>
            <mat-divider></mat-divider>
          }
        </mat-list>
      </div>

      <div class="step-actions">
        <button mat-button mat-dialog-close>Cancel</button>
        <button mat-raised-button color="primary" matStepperNext>
          <mat-icon>arrow_forward</mat-icon>
          Next
        </button>
      </div>
    </mat-step>

    <!-- Step 2: Select Permission -->
    <mat-step label="Select Permission">
      <div class="step-content">
        <div class="step-header">
          <mat-icon>search</mat-icon>
          <h3>Choose Permission to Apply</h3>
        </div>

        <p class="step-description">
          Search and select the permission that will be assigned to all {{ routeCount() }} routes
        </p>

        <!-- Permission Search -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Search Permissions</mat-label>
          <input
            matInput
            [matAutocomplete]="auto"
            [formControl]="permissionControl"
            placeholder="Type to search by name, description, or resource..."
          />
          <mat-icon matPrefix>shield</mat-icon>
          @if (permissionControl.value) {
            <button
              matSuffix
              mat-icon-button
              (click)="permissionControl.reset(); selectedPermission.set(null)"
              type="button"
              aria-label="Clear selection"
            >
              <mat-icon>close</mat-icon>
            </button>
          }
          @if (permissionControl.invalid && permissionControl.touched) {
            <mat-error>Permission is required</mat-error>
          }

          <mat-autocomplete
            #auto="matAutocomplete"
            [displayWith]="displayPermission"
          >
            @for (perm of filteredPermissions$ | async; track trackByPermissionId($index, perm)) {
              <mat-option [value]="perm">
                <div class="permission-option">
                  <mat-icon class="permission-icon">{{ getPermissionIcon(perm) }}</mat-icon>
                  <div class="permission-info">
                    <div class="permission-name">{{ perm.name }}</div>
                    @if (perm.description) {
                      <div class="permission-description">{{ perm.description }}</div>
                    }
                    @if (perm.resource) {
                      <div class="permission-resource">
                        <mat-icon>label</mat-icon>
                        {{ perm.resource }}
                      </div>
                    }
                  </div>
                </div>
              </mat-option>
            } @empty {
              <mat-option disabled>
                <div class="no-results">
                  <mat-icon>search_off</mat-icon>
                  <span>No permissions found</span>
                </div>
              </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <!-- Selected Permission Preview -->
        @if (selectedPermission()) {
          <mat-card appearance="outlined" class="selection-preview">
            <mat-card-header>
              <mat-icon mat-card-avatar color="primary">check_circle</mat-icon>
              <mat-card-title>Selected Permission</mat-card-title>
              <mat-card-subtitle>This permission will be applied to all routes</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="permission-details">
                <div class="detail-row">
                  <mat-icon>{{ getPermissionIcon(selectedPermission()!) }}</mat-icon>
                  <strong>{{ selectedPermission()!.name }}</strong>
                </div>
                @if (selectedPermission()!.description) {
                  <div class="detail-row description">
                    <mat-icon>description</mat-icon>
                    <span>{{ selectedPermission()!.description }}</span>
                  </div>
                }
                @if (selectedPermission()!.resource) {
                  <div class="detail-row">
                    <mat-icon>label</mat-icon>
                    <span>Resource: <strong>{{ selectedPermission()!.resource }}</strong></span>
                  </div>
                }
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious>
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <button
          mat-raised-button
          color="primary"
          matStepperNext
          [disabled]="!selectedPermission()"
        >
          <mat-icon>arrow_forward</mat-icon>
          Next
        </button>
      </div>
    </mat-step>

    <!-- Step 3: Confirm -->
    <mat-step label="Confirm">
      <div class="step-content">
        <div class="step-header">
          <mat-icon color="accent">done_all</mat-icon>
          <h3>Confirm Bulk Mapping</h3>
        </div>

        <p class="step-description">
          Review the bulk mapping operation before applying
        </p>

        <mat-card appearance="outlined" class="confirm-card">
          <mat-card-content>
            <div class="confirm-row">
              <mat-icon class="confirm-icon">route</mat-icon>
              <div class="confirm-label">
                <strong>Routes to Map:</strong>
                <span class="confirm-value">{{ routeCount() }} route{{ routeCount() !== 1 ? 's' : '' }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="confirm-row">
              <mat-icon class="confirm-icon">shield</mat-icon>
              <div class="confirm-label">
                <strong>Target Permission:</strong>
                <span class="confirm-value">{{ selectedPermission()?.name }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="confirm-row warning">
              <mat-icon class="confirm-icon" color="warn">warning</mat-icon>
              <div class="confirm-label">
                <strong>Warning:</strong>
                <span class="confirm-value">
                  Existing permission mappings on these routes will be overwritten
                </span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Sample Routes Preview -->
        <div class="sample-preview">
          <h4>
            <mat-icon>preview</mat-icon>
            Sample Routes (showing first 5)
          </h4>
          <mat-list dense>
            @for (route of data.routes.slice(0, 5); track trackByRouteId($index, route)) {
              <mat-list-item>
                <app-method-badge [method]="route.method" matListItemIcon />
                <span matListItemTitle>
                  <code>{{ route.path }}</code>
                </span>
              </mat-list-item>
            }
            @if (routeCount() > 5) {
              <mat-list-item>
                <mat-icon matListItemIcon>more_horiz</mat-icon>
                <span matListItemTitle class="more-text">
                  and {{ routeCount() - 5 }} more...
                </span>
              </mat-list-item>
            }
          </mat-list>
        </div>
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious [disabled]="loading()">
          <mat-icon>arrow_back</mat-icon>
          Back
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="onConfirm()"
          [disabled]="loading() || !selectedPermission()"
        >
          @if (loading()) {
            <mat-spinner diameter="20"></mat-spinner>
            <span>Applying...</span>
          } @else {
            <mat-icon>done_all</mat-icon>
            <span>Apply Mapping</span>
          }
        </button>
      </div>
    </mat-step>
  </mat-stepper>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions">
  <button mat-button mat-dialog-close [disabled]="loading()">Cancel</button>
</mat-dialog-actions>
