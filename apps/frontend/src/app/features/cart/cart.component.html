<!-- Syrian Marketplace Shopping Cart - Akita Version -->
<div class="cart-page" [dir]="language() === 'ar' ? 'rtl' : 'ltr'" [@.disabled]="prefersReducedMotion">

  <!-- Screen reader live region for cart status announcements (WCAG 4.1.3) -->
  <div class="sr-only" aria-live="polite" aria-atomic="true">
    {{ cartStatusMessage() }}
  </div>

  <!-- Cart Content -->
  <div class="container" *ngIf="(items$ | async) as items">

    <!-- Page Header -->
    <div class="cart-page__header">
      <div>
        <h1 class="cart-page__title">
          {{ language() === 'ar' ? 'سلة التسوق' : 'Shopping Cart' }}
        </h1>
        <p class="cart-page__subtitle" *ngIf="(itemCount$ | async) as count">
          {{ count }}
          {{ language() === 'ar'
            ? (count === 1 ? 'عنصر' : 'عناصر')
            : (count === 1 ? 'item' : 'items') }}
          {{ language() === 'ar' ? 'في سلتك' : 'in your cart' }}
        </p>
      </div>
    </div>

    <!-- Empty Cart State (SS-CART-011) -->
    <app-empty-cart
      *ngIf="items.length === 0"
      [language]="language()"
      [recommendedProducts]="recommendedProducts()"
      (startShopping)="continueShopping()"
      (browseCategories)="browseCategoriesClick()"
      (addToCart)="onRecommendedProductAddToCart($event)">
    </app-empty-cart>

    <!-- Cart with Items -->
    <div *ngIf="items.length > 0" class="cart-page__content">

      <!-- Cart Items Section -->
      <div class="cart-page__items">

        <!-- Cart Actions Bar -->
        <div class="cart-page__actions-bar">
          <span class="cart-page__item-count">
            {{ (itemCount$ | async) }}
            {{ language() === 'ar' ? 'عناصر' : 'items' }}
          </span>
          <button mat-button color="warn" (click)="clearCart()">
            <mat-icon>delete_outline</mat-icon>
            {{ language() === 'ar' ? 'إفراغ السلة' : 'Clear Cart' }}
          </button>
        </div>

        <!-- Cart Items List -->
        <div class="cart-page__items-list">
          <mat-card *ngFor="let item of items; trackBy: trackByItemId" @cartItemAnimation class="cart-item">
            <div class="cart-item__content">

              <!-- Product Image -->
              <div class="cart-item__image">
                <img
                  [src]="item.product.images?.[0]?.url || '/assets/images/placeholder.svg'"
                  [alt]="item.product.name"
                  loading="lazy">
              </div>

              <!-- Product Info -->
              <div class="cart-item__info">
                <h3 class="cart-item__name">
                  <a [routerLink]="['/product', item.product.slug]">
                    {{ item.product.name }}
                  </a>
                </h3>

                <p class="cart-item__category">
                  {{ item.product.category.name }}
                </p>

                <!-- Stock Status (SS-CART-007) -->
                <app-stock-alert
                  [status]="getStockStatus(item.product.id).status"
                  [quantity]="item.product.inventory?.quantity"
                  [language]="language()">
                </app-stock-alert>
              </div>

              <!-- Quantity & Price -->
              <div class="cart-item__controls">
                <!-- Quantity Selector -->
                <div class="cart-item__quantity">
                  <label>{{ language() === 'ar' ? 'الكمية:' : 'Quantity:' }}</label>
                  <div class="cart-item__quantity-controls">
                    <button
                      mat-icon-button
                      (click)="updateQuantity(item.id, item.quantity - 1)"
                      [disabled]="item.quantity <= 1"
                      [attr.aria-label]="language() === 'ar'
                        ? 'تقليل كمية ' + item.product.name
                        : 'Decrease quantity of ' + item.product.name">
                      <mat-icon>remove</mat-icon>
                    </button>
                    <span
                      class="cart-item__quantity-value"
                      role="status"
                      [attr.aria-label]="language() === 'ar'
                        ? 'الكمية: ' + item.quantity
                        : 'Quantity: ' + item.quantity">
                      {{ item.quantity }}
                    </span>
                    <button
                      mat-icon-button
                      (click)="updateQuantity(item.id, item.quantity + 1)"
                      [disabled]="item.quantity >= (item.product.inventory?.quantity || 0)"
                      [attr.aria-label]="language() === 'ar'
                        ? 'زيادة كمية ' + item.product.name
                        : 'Increase quantity of ' + item.product.name">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </div>

                <!-- Price -->
                <div class="cart-item__price">
                  <span class="cart-item__price-label">
                    {{ language() === 'ar' ? 'السعر:' : 'Price:' }}
                  </span>
                  <span class="cart-item__price-value">
                    {{ formatPrice(item.product.price.amount * item.quantity, 'SYP') }}
                  </span>
                </div>

                <!-- Remove Button -->
                <button
                  mat-icon-button
                  color="warn"
                  class="cart-item__remove"
                  (click)="removeItem(item)"
                  [matTooltip]="language() === 'ar' ? 'إزالة من السلة' : 'Remove from cart'"
                  [attr.aria-label]="language() === 'ar'
                    ? 'إزالة ' + item.product.name + ' من السلة'
                    : 'Remove ' + item.product.name + ' from cart'">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </mat-card>
        </div>
      </div>

      <!-- Cart Summary Sidebar -->
      <div class="cart-page__summary">
        <mat-card class="cart-summary">
          <mat-card-header>
            <mat-card-title>
              {{ language() === 'ar' ? 'ملخص الطلب' : 'Order Summary' }}
            </mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <!-- Subtotal -->
            <div class="cart-summary__row">
              <span>{{ language() === 'ar' ? 'المجموع الفرعي:' : 'Subtotal:' }}</span>
              <span>{{ formatPrice((subtotal$ | async) || 0, 'SYP') }}</span>
            </div>

            <mat-divider></mat-divider>

            <!-- Coupon Section -->
            <div class="cart-summary__coupon">
              <h4>{{ language() === 'ar' ? 'لديك كوبون؟' : 'Have a coupon?' }}</h4>
              <div class="cart-summary__coupon-input">
                <mat-form-field appearance="outline" class="flex-1">
                  <mat-label>{{ language() === 'ar' ? 'رمز الكوبون' : 'Coupon Code' }}</mat-label>
                  <input
                    matInput
                    [ngModel]="couponCode()"
                    (ngModelChange)="couponCode.set($event)"
                    [placeholder]="language() === 'ar' ? 'أدخل الرمز' : 'Enter code'"
                    [disabled]="isApplyingCoupon()"
                    [attr.aria-describedby]="couponError() ? 'coupon-error' : null"
                    [attr.aria-invalid]="couponError() ? 'true' : 'false'">
                </mat-form-field>
                <button
                  mat-raised-button
                  color="accent"
                  (click)="applyCoupon()"
                  [disabled]="!couponCode() || isApplyingCoupon()">
                  {{ isApplyingCoupon()
                    ? (language() === 'ar' ? 'جارٍ التطبيق...' : 'Applying...')
                    : (language() === 'ar' ? 'تطبيق' : 'Apply') }}
                </button>
              </div>
              <p class="cart-summary__coupon-error" id="coupon-error" role="alert" *ngIf="couponError()">
                {{ couponError() }}
              </p>
              <p class="cart-summary__coupon-hint">
                {{ language() === 'ar' ? 'جرّب: SYRIA10 أو WELCOME15' : 'Try: SYRIA10 or WELCOME15' }}
              </p>
            </div>

            <mat-divider></mat-divider>

            <!-- Total -->
            <div class="cart-summary__row cart-summary__row--total">
              <span>{{ language() === 'ar' ? 'الإجمالي:' : 'Total:' }}</span>
              <span>{{ formatPrice((total$ | async) || 0, 'SYP') }}</span>
            </div>
          </mat-card-content>

          <mat-card-actions>
            <button
              mat-raised-button
              color="primary"
              class="cart-summary__checkout-btn"
              (click)="proceedToCheckout()">
              <mat-icon>lock</mat-icon>
              {{ language() === 'ar' ? 'الدفع' : 'Proceed to Checkout' }}
            </button>
            <button
              mat-stroked-button
              class="cart-summary__continue-btn"
              (click)="continueShopping()">
              <mat-icon>shopping_bag</mat-icon>
              {{ language() === 'ar' ? 'متابعة التسوق' : 'Continue Shopping' }}
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>

    <!-- Product Recommendations Section -->
    <div *ngIf="items.length > 0 && recommendedProducts().length > 0" class="cart-page__recommendations">
      <h2 class="cart-page__recommendations-title">
        <mat-icon>recommend</mat-icon>
        {{ language() === 'ar' ? 'قد يعجبك أيضاً' : 'You might also like' }}
      </h2>

      <div class="cart-page__recommendations-grid">
        <app-product-box-grid
          *ngFor="let product of recommendedProducts(); trackBy: trackByProductId"
          [product]="product"
          [language]="language()"
          (addToCart)="addRecommendedProductToCart($event)">
        </app-product-box-grid>
      </div>
    </div>

    <!-- Customers Also Bought Section -->
    <div *ngIf="items.length > 0 && customersAlsoBought().length > 0" class="cart-page__also-bought">
      <h2 class="cart-page__also-bought-title">
        <mat-icon>people</mat-icon>
        {{ language() === 'ar' ? 'اشترى العملاء أيضاً' : 'Customers also bought' }}
      </h2>

      <app-product-recommendations-carousel
        *ngIf="getFirstCartProductId()"
        [productId]="getFirstCartProductId()"
        [title]="language() === 'ar' ? 'اشترى العملاء أيضاً' : 'Customers Also Bought'"
        (productClick)="onRecommendedProductClick($event)"
        (addToCart)="onRecommendedProductAddToCart($event)">
      </app-product-recommendations-carousel>
    </div>
  </div>
</div>
